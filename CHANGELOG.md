# Changelog

모든 중요한 변경 사항은 이 문서에 기록됩니다.

---
## [2.0] - 2025-06-10

### 추가
- **야간 모드 처리 루틴 전면 구현 (MEGA_V8)**
  - `handleNightMode()` 도입으로 감지 → 경보 → 인증 → 복귀 흐름 구성
  - 관리자 인증 없이는 RFID·LCD·센서 모두 차단
  - 감지 중에도 로그 기록 및 외부 통신 가능

- **복합 센서 기반 감지 시스템 구축 (MEGA_V8)**
  - 화재 감지: 온도(DS18B20), 조도, 불꽃 센서
  - 인체 감지: MPU6050, 초음파(2), PIR(2), 충격, 사운드 센서 등 7종 센서 조합

- **관리자 인증 경로 다양화 (MEGA_V8)**
  - RFID + 키패드 / IR 리모컨 입력 모두 지원
  - 인증 성공 시만 메뉴 접근 가능

- **경보 출력 및 외부 연동 강화 (MEGA_V8)**
  - LED/부저 15초간 깜빡임 유지
  - Serial1.write('1')로 외부 연동 신호 전송

- **Charge_V1: 스마트 환기 시스템 코드 추가**
  - 실내/실외 온습도, 조도, 전압, 수위, 창문 상태, 사람 감지 등 7종 센서 통합
  - `SoftwareSerial` 기반 Bluetooth 통신 (`BT_RX=3`, `BT_TX=4`) 추가
  - 조건별 경보 코드 전송:  
    - '0': 야간 창문 열림  
    - '1': 겨울철 실내 온도 과열  
    - '2': 여름철 실내 온도 과냉  
    - '3': 습도 낮음  
    - '4': 습도 높음  
    - '5': 수위 높음 + 창문 닫힘  
  - 사람 감지 시 7세그 출력 및 부저 조건부 울림

- **UNO_V1: 트래킹 자율주행 시스템 추가**
  - 4개의 L298N 기반 모터 드라이버 제어
  - 3점 트래킹 센서 기반 흑선 인식 (A0~A2)
  - WBW / WBB / BBW / WWB / BWW / BBB 등 센서 조합별 모션 정의
  - 전진, 좌우회전, 후진, 정지 모드 구성
  - 1초 이상 흰색 지속 시 정지하는 탐색 로직 포함
  - PWM 속도 조절 및 모드 전환 시 안전 정지 구현

### 개선
- **MEGA_V8: 감지 처리 루틴 비차단 방식으로 개선**
  - `loop()` 루틴 내 상태 기반 타이머 처리
  - 사용자 입력 및 경보 처리 병렬 유지

- **Charge_V1: 부저·세그먼트 출력 안정화**
  - 가변저항 기반 주파수 맵핑 처리
  - 사람 미감지 시 항상 부저와 7세그 OFF

- **UNO_V1: 모드별 속도 조정 및 탐색 제어 개선**
  - 좌/우 회전 시 비대칭 속도 설정 가능 (`forwardSpeedControl`, `turnSpeedControl`)
  - 흰색 탐색 종료 조건 추가 (1초 이상 무검출 시 정지)

### 기타
- MEGA_V8: 로그 저장 함수 리팩토링 (`logEvent()` 통합)
- MEGA_V8: 디버그 모드에서는 실제 알림 출력 차단
- Charge_V1: 모든 센서 값 실시간 시리얼 출력 지원
- UNO_V1: 모터 방향 주석 명확화 및 시퀀스 안전 처리

## [1.6] - 2025-06-03

### 추가
- **설정 메뉴의 감지 모드 선택 기능 추가**
  - 화재 감지 모드: ON / OFF / 디버그(DBG)
  - 인체 감지 모드: ON / OFF / 디버그(DBG)
  - 디버그 모드일 경우 센서 측정값 및 판정 결과 시리얼로 실시간 출력

- **화재 감지 및 인체 감지 디버깅 메시지 출력** 구현
  - 각 센서에 대해 유지시간, 측정값, 임계값을 포함한 로그 제공
  - 감지 중 상태 / 감지 완료 여부 등 상태 구분 가능

### 개선
- **야간 모드 상태에서 Bluetooth ‘0’ 수신 시 TX1로 ‘1’ 전송 기능 추가**
  - 야간 모드에서 별도 조건 없이 외부 제어 가능

- **화재 감지 센서 평가 로직 세분화**
  - DS18B20, 조도 센서, 불꽃 센서 각각 별도 판단 및 유지시간 조건 적용
  - 판정 조건 만족 시 로그 저장 후 15초간 경보

- **인체 감지 센서 평가 방식 개선**
  - MPU6050 기반 기울기, 초음파 센서 2개, 충격 센서, PIR 센서 2개, 사운드 감지 센서 병합 판단
  - 다수 센서 동시에 감지 시 경보 상태 진입

### 변경
- **야간 모드 루틴 구조 전면 재정비**
  - 초기화 상태 구분 및 진입 시 센서·LED·부저 초기화
  - 경보 상태 종료 후 자동 리셋 루틴 적용

- **디버그 모드 진입 시 LED/부저 경보 비활성화 처리**
  - 시리얼 디버깅만 수행하며 실제 알림은 발생하지 않음

### 기타
- 화재 및 인체 감지 경보 발생 시 TX1로 '1' 신호 전송
- 리팩토링: holdStateFire(), holdStateHuman() 함수 통합 구조 강화

## [1.5] - 2025-06-01

### 추가
- **화재 감지/인체 감지 로그 탐색 기능** 추가:
  - 로그 항목 탐색 시 시간, ID 출력
  - 개별 항목 삭제 및 전체 초기화 기능 포함
  - 로그 탐색 시 `#` 키로 항목 뷰 진입 가능

- **화재 감지/인체 감지 감지 모드 설정 기능** 추가:
  - 관리자 메뉴 > 설정에서 각각 ON/OFF/디버그 모드 선택 가능
  - 디버그 모드에서는 모든 센서 상태를 실시간 시리얼 출력

- **초음파 센서 거리 측정 함수 `getDistance()`** 구현
  - 거리 미측정 시 -1 반환 처리

- **화재 감지 시 15초간 LED/부저 알림 후 자동 종료**
- **인체 감지 시 15초간 LED/부저 알림 후 자동 종료**
- **관리자 PIN 입력 루틴 개선**:
  - 잘못된 입력 시 재시도 루프 구현
  - 키패드와 리모컨 PIN 입력 UI 통일

### 개선
- **비차단 LED/부저 경보 시스템 보강**:
  - 감마 보정 기반 밝기/음량 설정 적용
  - 밝기 0일 경우 LED 완전 OFF

- **야간 모드 전환 구조 재정비**:
  - 센서 상태 유지 및 관리자 모드 진입 루틴 분리
  - 초기 진입 시 LCD 안내 표시 추가

- **관리자 메뉴 구성 변경**:
  - 3: 인체 감지 로그, 4: 화재 감지 로그 메뉴 정식 탑재
  - 기존 3/4번 메뉴 확장

### 변경
- **화재 감지 로직 분리 및 디버깅 기능 내장**:
  - `holdStateFire()` 함수 개선: 디버그 출력 포함
- **인체 감지 로직 정리 및 조건 분리**:
  - `holdStateHuman()` 함수 개선: 조건별 디버그 및 유지시간 체크 내장

### 기타
- `setup()` 및 `loop()` 함수 구조 정비
  - RFID, LCD, 센서, 로터리 등 핀 초기화 정리
  - 주간/야간 모드 스위칭 흐름 명확화

## [1.4] - 2025-06-01

### 추가
- **야간 모드(Night Mode)** 기능 도입:
  - 설정 메뉴에서 주간/야간 모드 전환 가능
  - 야간 모드 진입 시 RFID, LCD 자동 OFF 및 센서 기반 화재 감지 모드 활성화
  - 택트 스위치 또는 IR 리모컨을 통해 관리자 인증(PIN) 후 주간 모드 복귀 가능
- **화재 감지 기능** 정식 도입:
  - 온도 센서(DS18B20), 조도 센서, 불꽃 센서를 활용한 3중 감지
  - 각 센서별 5초 유지 기준의 조건 hold 감지
  - 화재 발생 시 LED 및 부저 패턴 경고, 로그 기록(`LOG3/`)
- **화재 로그 메뉴(관리자 메뉴 4번)** 추가:
  - 날짜별 화재 기록 열람 및 개별/전체 삭제 가능
  - 개별 항목 탐색 및 삭제 기능 지원
- **비밀번호(PIN) 기반 관리자 인증** 기능 도입:
  - 관리자 메뉴 진입 시 관리자 카드 태깅 후 비밀번호 입력 필요
  - IR 리모컨으로도 PIN 직접 입력 가능
- **조도 센서 및 불꽃 센서 하드웨어 연동 완료**
  - 센서 상태 모니터링 및 로그 기록 포함

### 개선
- **출퇴근/인체 감지 로그 탐색** 기능 향상:
  - 항목별 시간(ID 포함) 출력
  - 삭제/초기화 UI 통일
- **LED/부저 패턴 초기화 로직 정리**
  - 야간 모드 진입/이탈 시 명확하게 상태 초기화
- **초기화 및 시스템 종료 시 LED/OFF 상태 확실하게 반영**

### 변경
- `menuSetting()` 내 야간모드 진입 로직 보강 (즉시 RFID/LCD OFF 처리)
- 관리자 메뉴 진입 방식 변경: 단순 카드 인식 → 카드 + PIN 방식

### 기타
- 각종 변수 및 주석 정비
- 설정값 `config.txt`에 ID/PW도 저장하도록 구조 통합
- 디버깅을 위한 `Serial.print()` 일부 추가

---

## [1.3] - 2025-05-27

### 추가
- 관리자 메뉴 5번: **설정 관리 (밝기/볼륨 조절)** 기능 추가
  - 로터리 엔코더 기반 밝기 조절
  - 부저 볼륨 조절 기능
  - 설정값 SD카드에 저장 및 로드 (`SET/config.txt`)
- **LED 깜빡임 + 부저 사운드** 제어를 위한 비차단 상태 머신 구현
  - 감마 보정 기반 깜빡임 주기 설정
  - 밝기 0일 경우 자동 OFF
  - 부저 주파수 볼륨에 따라 자동 조절
- **시프트 레지스터 제어**(74HC595)로 RGB LED 제어 기능 추가

### 개선
- 관리자 메뉴 구조 개선:
  - 조이스틱 기반 페이지 넘김 기능 도입
  - LCD 상단에 현재 페이지 및 메뉴 번호 표시
- 로터리 엔코더 디바운싱 및 방향 감지 개선:
  - 2핀 인터럽트 기반 처리
  - 4스텝 누적 알고리즘 적용

### 변경
- `setup()` 내 시리얼 초기화 이후 설정값(`brightness`, `volumeLevel`)을 SD카드에서 불러오도록 수정
- 관리자 메뉴 내 `Users`, `Commute` 하위 메뉴의 삭제 시 확인 메시지 개선

### 기타
- 주석 정비 및 핀 배열 정리
- 감마 보정 및 조이스틱 인터페이스 코드 정리
- 향후 `menuPeople()` 및 `menuFire()` 함수 확장 여지를 남김

---

## [1.2] - 2025-05-26

### 추가
- 절전 기능 도입:
  - IR 센서 또는 택트 스위치 입력 시 시스템 자동 활성화
  - 10초 동안 입력 없으면 시스템 자동 비활성화 (LCD 백라이트 OFF, RFID 안테나 OFF)
- 비활성화 상태 관리를 위한 전역 변수 추가:
  - `systemActive`, `activeStart`, `activeTimeout` 등
- 택트 스위치 핀 (`WAKE_BUTTON_PIN`) 및 IR 센서 핀 (`IR_SENSOR_PIN`) 설정 추가
- RFID RST 핀 전원 제어 로직 추가: 활성화 시 HIGH, 비활성화 시 LOW
- 로그 파일을 최신순으로 불러오는 함수 `getCommuteFileAt_Desc()` 추가
- 출퇴근 로그를 최신순으로 조회하도록 `menuCommute()` 개선

### 개선
- `logCommute()` 함수에서 최신 로그를 **파일 맨 위에 저장**하도록 변경
- 사용자 입력 발생 시마다 타이머 초기화:
  - 키패드 입력, 조이스틱 스크롤, 사용자 등록, 관리자 메뉴 진입/종료 등
- RFID 태그가 없을 경우 루프 조기 종료로 전력 소모 최소화

### 기타
- 코드 전반에 전력 절감 및 유휴 상태 처리를 위한 리팩토링 수행
- 향후 사람 감지 및 화재 감지 기능 확장을 위한 구조 유지

---

## [1.1] - 2025-05-25

### 추가
- 관리자 메뉴에서 출퇴근 로그 관리 기능(menuCommute) 추가:
  - 날짜별 로그 조회 및 항목 삭제 기능
  - 로그 항목 하나씩 삭제 또는 전체 로그 초기화 지원
- 조이스틱 기반 스크롤 기능 추가:
  - 사용자 목록 및 로그 조회 시 아날로그 조이스틱으로 페이지 이동 가능
  - 빠른 스크롤 모드(1초 이상 유지 시) 지원
- 사용자 조회 시, 키패드 외에 조이스틱을 이용한 상하 탐색 가능
- 관리자 메뉴 선택지 확장: 1=USERS, 2=COMMUTE, 3=PEOPLE(예약), 4=FIRE(예약)

### 개선
- `getNavScroll()` 함수로 조이스틱 입력 처리 로직 분리
- 키패드의 논블로킹 입력 함수(`getNavKeyNB()`) 도입
- 사용자 삭제 시 확인 메시지(1:Yes, 2:No) 표시로 오동작 방지
- 출퇴근 로그 파일명을 날짜 기반(`YYYYMMDD.TXT`)으로 정렬 가능하게 구현
- 사용자 등록, 로그 기록 등 주요 함수에 주석 및 안정화 코드 보강

### 기타
- 전체 코드에 설명 주석 정리 및 일관성 강화
- 추후 기능 확장(사람 감지, 화재 감지)을 위한 관리자 메뉴 레이아웃 준비

---

## [1.0] - 2025-05-23

### 주요 기능
- RFID + RTC 기반 자동 출퇴근 기록 시스템 구축
- LCD(I2C)와 키패드(4×4) 연동 UI 구현
- 관리자 기능 구현:
  - 사용자 목록 조회 및 삭제
  - 관리자 사번 입력 시 별도 메뉴 진입
- UID-사번 매핑 등록 기능
- SD 카드 사용:
  - 사용자 정보 저장
  - 출퇴근 로그 기록 (`LOG1/YYYYMMDD.TXT`)
- 순수 Arduino 환경에서 작동하는 통합 출입 시스템 구축
- 시간 표시 함수 및 사용자 입력 기능 (`inputID`, `displayTime`) 구현

### 시스템 구성
- RFID (MFRC522), RTC (DS1302), LCD, 키패드, SD카드 모듈 통합
- 관리자 코드: `22011949`
- SD 카드 구조:
  - `USERS/` 폴더: UID별 사용자 정보
  - `LOG1/`: 출퇴근 로그 기록

### 기타
- 핀 번호 정리 및 주석 체계화
- SD 카드 오류 발생 시 시스템 정지 처리
